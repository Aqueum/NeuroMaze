<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>NeuroMaze</title>
<style>
  body { margin:0; background:#000; color:#fff; font-family:Arial, sans-serif; }
  #gameContainer { position:relative; width:100%; height:80vh; background:#333; display:flex; align-items:center; justify-content:center; }
  #uiOverlay { position:absolute; top:10px; left:10px; z-index:999; background:rgba(0,0,0,0.5); padding:10px; }
  #directionButtons { position:absolute; bottom:10px; width:100%; display:flex; justify-content:center; }
  .arrowBtn { margin:0 20px; padding:10px; background:#444; color:#fff; border:none; cursor:pointer; font-size:1.2em; }
  #startScreen { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:20px; }
  #mazeView { width:100%; height:100%; background:#222; }
</style>
</head>
<body>

<div id="gameContainer">
  <canvas id="mazeView"></canvas>
  <div id="startScreen">
    <h1>Win a £25 Amazon Gift Card!</h1>
    <p>The first person to complete the maze without cheating in as few moves as possible will win.</p>
    <p>Please enter your email address to enter the prize draw. We will use it to verify no cheating and send the gift card. We will delete all non-winning emails after awarding the prize.</p>
    <p><input type="email" id="emailInput" placeholder="Enter email" style="width:200px;" /></p>
    <p><label><input type="checkbox" id="saveCookie" /> Save email in a cookie</label></p>
    <button id="startButton">Start Game</button>
  </div>
  <div id="uiOverlay">
    <div>Moves: <span id="movesCount">0</span></div>
  </div>
  <div id="directionButtons">
    <button class="arrowBtn" id="leftBtn">← Left</button>
    <button class="arrowBtn" id="rightBtn">Right →</button>
  </div>
</div>

<script>
const canvas = document.getElementById('mazeView');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight * 0.8;

let emailHash = '';
let userEmail = '';
let moves = 0;
let mazePath = []; // store turns: "L" or "R"
let mazeCompleted = false;

// For demo purposes, let's say the maze completes after 20 moves:
let minimalMoves = 20;

window.addEventListener('load', () => {
  const savedEmailEncoded = document.cookie.replace(/(?:(?:^|.*;\s*)mazeEmail\s*\=\s*([^;]*).*$)|^.*$/, "$1");
  if (savedEmailEncoded) {
    const decodedEmail = decodeURIComponent(savedEmailEncoded);
    document.getElementById('emailInput').value = decodedEmail;
    document.getElementById('saveCookie').checked = true;
  }
});

function drawMazeView() {
  ctx.fillStyle = '#000';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = '#555';
  ctx.fillRect(canvas.width/2 - 50, canvas.height/2 - 50, 100, 100); 
  // Placeholder "wall" view
}

// Simple SHA-256 hash for email (deterministic)
async function sha256(message) {
  const msgBuffer = new TextEncoder().encode(message);
  const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
}

document.getElementById('startButton').addEventListener('click', async () => {
  userEmail = document.getElementById('emailInput').value.trim().toLowerCase();
  if (!userEmail) {
    alert("Please enter an email address.");
    return;
  }

  if (document.getElementById('saveCookie').checked) {
    document.cookie = "mazeEmail=" + encodeURIComponent(userEmail) + "; path=/; max-age=31536000";
  } else {
    // If unchecked, clear any existing cookie
    document.cookie = "mazeEmail=; path=/; max-age=0";
  }

  emailHash = await sha256(userEmail);
  // For debugging, console.log(userEmail, emailHash) to verify stable hash
  console.log("Email:", userEmail, "Hash:", emailHash);

  document.getElementById('startScreen').style.display = 'none';
  drawMazeView();
});

document.getElementById('leftBtn').addEventListener('click', () => makeMove('L'));
document.getElementById('rightBtn').addEventListener('click', () => makeMove('R'));

function makeMove(direction) {
  if (mazeCompleted) return;
  moves++;
  mazePath.push(direction);
  document.getElementById('movesCount').textContent = moves;
  
  // Maze completion logic: once moves == minimalMoves, complete
  if (moves === minimalMoves) {
    mazeCompleted = true;
    onMazeComplete();
  }

  drawMazeView();
}

document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft') {
      makeMove('L');
    } else if (e.key === 'ArrowRight') {
      makeMove('R');
    }
  });  

function onMazeComplete() {
  alert("Maze completed in " + moves + " moves!");
  logToCSV(userEmail, emailHash, moves, mazePath);
  if (moves === minimalMoves) {
    // Minimal moves scenario: send email to admin
    console.log("Email admin: Completed with minimal moves:", userEmail, emailHash);
    // Here you'd implement fetch() to your backend email notification if desired
  }
}

function logToCSV(email, hash, moves, path) {
  const record = [new Date().toISOString(), hash, moves, path.join('')].join(',');
  console.log("Log line for CSV:", record);
  // If backend is set up:
  // fetch('http://localhost:8000/append_to_csv', {
  //   method:'POST',
  //   headers:{'Content-Type':'application/json'},
  //   body:JSON.stringify({line:record})
  // }).then(res=>res.json()).then(console.log).catch(console.error);
}

window.addEventListener('resize', () => {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight * 0.8;
  drawMazeView();
});

drawMazeView();
</script>

</body>
</html>
